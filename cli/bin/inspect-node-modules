#! /usr/bin/env node

const minimist = require('minimist');
const path = require('path');
const fs = require('fs');
const { listFiles } = require('fs-directory');
const argv = minimist(process.argv.slice(2));

if (argv._.length === 0) {
    console.info('needs explicit directories, will not run on cwd');
    return 1;
}

const extractPostInstall = (filename) => {
    const data = fs.readFileSync(filename).toString();
    try {
        const packageInfo = JSON.parse(data);
        const scripts = packageInfo['scripts'];
        const postInstall = scripts ? scripts['postinstall'] : undefined;
        if (postInstall) {
            console.info('** inspect: ', filename);
            console.info({postInstall});
        }
    } catch(error) {
        console.error('** failed inspect: ', {
            filename,
            error
        });
    }
}

const directories = argv._.map(item => path.resolve(process.cwd(), item, 'node_modules'));
const packages = directories.flatMap(directory => listFiles(directory, {
    fileFilter: (entry) => entry.name === 'package.json',
    directoryFilter: () => true
}));

packages.forEach(extractPostInstall);
