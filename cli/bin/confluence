#!/usr/bin/env bash

_product_definition() {
    _with_arguments 1 "$@"
    version=${1}
    echo "-Dproduct=confluence
          -Dproduct.version=${version}
          -Dhttp.port=${HTTP_PORT:-8080}
          -Dcontext.path=${CONTEXT_PATH:-"/confluence"}
          -Dserver=localhost
          -Dajp.port=${AJP_PORT:-8009}
          -Dplugins=com.atlassian.confluence.plugins:confluence-functestrpc-plugin:${version},com.atlassian.confluence.plugins:confluence-scriptsfinished-plugin:${version},com.atlassian.confluence.plugins:confluence-functest-rest-plugin:${version}
          "
}

_product_name() {
    echo "confluence"
}

_product_group_id() {
    echo "com.atlassian.confluence"
}

_product_webapp_name() {
    echo "confluence-webapp"
}

source atlassian-product.sh

_start_cmd() {
    _run_with_jvm_args "
    -Xms1024m -Xmx2048m
    -Datlassian.plugins.startup.options=disable-addons=com.atlassian.migration.agent
    -Datlassian.dev.mode=false
    -Dpdf.export.sandbox.disable=${NO_SANDBOX:-false}
    -Dsynchrony.port=${SYNCHRONY_PORT:-9091}" \
    $(_product_definition "$@")
}

_debug_cmd() {
    _run_with_jvm_args "
    -Xms1024m -Xmx2048m
    -Datlassian.plugins.startup.options=disable-addons=com.atlassian.migration.agent
    -Datlassian.dev.mode=true
    -Datlassian.disable.caches=true
    -Datlassian.webresource.disable.minification=true
    -Dconfluence.context.batching.disable=true
    -Dplugin.webresource.batching.off=true
    -Dpdf.export.sandbox.disable=${NO_SANDBOX:-false}
    -Xdebug
    -Xrunjdwp:transport=dt_socket,address=${DEBUG_PORT:-5005},server=y,suspend=n
    -Dsynchrony.port=${SYNCHRONY_PORT:-9091}" \
    $(_product_definition "$@")
}

eval "$@"

if [[ -z $1 ]]; then
    $0 -h
fi
